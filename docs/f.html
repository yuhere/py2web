<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spelling</title>
  <meta name="viewport" content="initial-scale=1.0"/>
<style>

body {
    font-family: Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;
    font-size: 20px;
}


div.pbk {
    page-break-before: always;
}

div.block {
    border: solid black 1px;
    width: 685px;
    padding: 2px;
    /*height: 800px;*/
}

div#qheader {
    border: 0px;
    padding: 0px;
    margin: 0px;
}

div.status {
    border: solid black 1px;
    padding: 0px;
    margin: 0px;
    height: 30px;
    padding: 1px;
}

span#remaining {
    /*border: solid black 1px;*/
    float: right;
}
span#ir_count {
    /*border: solid black 1px;*/
    float: left;
}

p, input.i, span.c {
    font-family: Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace;
    font-size: 20px;
    white-space: pre-wrap;
    padding: 0px;
    letter-spacing: 7px;
    line-height: 40px;
}

span.c {   /* 单个不可输入字符 */
    border: solid white 1px;
    width: 13px;
    margin: 1px; 
    text-rendering: auto;
    color: initial;
    letter-spacing: normal;
    word-spacing: normal;
    text-transform: none;
    text-indent: 0px;
    text-shadow: none;
    display: inline-block;
    text-align: start;
    background-color: white;
    cursor: text;
}

span.s {   /* 单个可输入字符，边框 */
    border: solid gray 1px;
}

span.f {    /* 获得焦点时，边框变色 */
    border: solid blue 1px;
	background-color:aliceblue; 
}

span.x {    /* 错误答案时，用红色显示 */
    color: red;
    background-color:yellow; 
}

input.i { /* 浮动输入框 */
    border: solid gray 0px;
    width: 0px;
    /*margin: 1px; */
    text-rendering: auto;
    color: initial;
    letter-spacing: normal;
    word-spacing: normal;
    text-transform: none;
    text-indent: 0px;
    text-shadow: none;
    display: inline-block;
    text-align: start;
    background-color: white;
    cursor: text;
    line-height: 38px;
    outline:none;
    background-color:aliceblue; 
}

input.i:focus { 
    /* background-color:yellow; */
}


input.l, span.l {
    text-transform: lowercase;
}

input.u, span.u {
    text-transform: uppercase;
}

span.w {
    text-rendering: auto;
    color: initial;
    letter-spacing: normal;
    word-spacing: normal;
    text-transform: none;
    text-indent: 0px;
    text-shadow: none;
    display: inline-block; /* inline 会让它不按词换行 */
    text-align: start;
    background-color: white;
    cursor: text;
}

@media screen {

    div#question.normal {
        display: none;
    }

    div#answer.normal {
        display: block;
    }

    div#question.exam {
        display: block;
    }

    div#answer.exam {
        display: none;
    }
	
    div#question.finish {
        display: block;
    }

    div#answer.finish {
        display: none;
    }

}

@media print {
    
    div#header {
        display: none;
    }
    
    div#question.normal {
        display: block;
    }

    div#answer.normal {
        display: block;
		page-break-before: always;
    }

    div#question.exam {
        display: block;
    }

    div#answer.exam {
        display: none;
    }
	
    div#question.finish {
        display: block;
    }

    div#answer.finish {
        display: none;
    }

}

</style>
</head>
<body>
<div id="main"></div>
<script>
<!--
var dat = {"marked":"0123456789012345678901234567890123456789\n<w>Transcript</w>:\nJack: <w>Hi</w> <w>there</w>, I’m Jack. \n\nSarah: <w>And</w> I'm Sarah. Welcome to Everyday English! Today we're <w>talking</w> about making friends! \n"};


function fmtd(_date, _format) {
  _format = _format === undefined ? 'yyyy-MM-dd hh:mm:ss' : _format;
  var o = {
    "M+": _date.getMonth() + 1, //month
    "d+": _date.getDate(), //day
    "h+": _date.getHours(), //hour
    "m+": _date.getMinutes(), //minute
    "s+": _date.getSeconds(), //second
    "q+": Math.floor((_date.getMonth() + 3) / 3), //quarter
    "S": _date.getMilliseconds() //millisecond
  };
  if (/(y+)/.test(_format)) {
    _format = _format.replace(RegExp.$1, (_date.getFullYear() + "").substr(4 - RegExp.$1.length));
  }
  for (var k in o) {
    if (new RegExp("(" + k + ")").test(_format)) {
      _format = _format.replace(RegExp.$1, RegExp.$1.length == 1
        ? o[k]
        : ("00" + o[k]).substr(("" + o[k]).length)
      );
    }
  }
  return _format;
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;");
}
//
var playA = (function SimpleAudioPlayer() {
  var ele = new Audio(), ready = false;
  //
  if (/i(Phone|P(o|a)d)/.test(navigator.userAgent)) {
    var self = this;
    //
	var handler = function(){
      ele.load();
      ready = true;
      return false;
	  document.removeEventListener("touchstart", handler);
	};
	document.addEventListener("touchstart", handler);
  } else {
    ready = true;
  }
  //  
  return function(src) {
	  if (ready) {
	    ele.pause();
	    ele.src = src;
		ele.play();
	  }
	}
})();
//
function wrap_tag(t, cls, w) {
  return "<" + t + " class=\"" + cls + "\">" + w + "</" + t + ">";
}

function cwrap(segment, cls) {
  cls = cls === undefined ? "c" : cls;
  var _html = [];
  for (var i=0;i<segment.length;i++) {
    _html.push(wrap_tag("span", cls, escapeHtml(segment.charAt(i))));
  }
  return _html.join("");
}

function wwrap(segment) {
  var _html = [];
  var regex = /([a-z0-9]+)/ig;
  var m, lastIndex = 0;
  while ((m = regex.exec(segment)) !== null) {
      // This is necessary to avoid infinite loops with zero-width matches
      if (m.index === regex.lastIndex) {
          regex.lastIndex++;
      }
      var w = m[1], pre = segment.substring(lastIndex, m.index);
      lastIndex = m.index + m[0].length;
      _html.push(cwrap(pre));
      _html.push(wrap_tag("span", "w", cwrap(w)));
  }
  _html.push(cwrap(segment.substring(lastIndex)));
  //
  return _html.join("");
}
//
function mwwrap(w, widx) {
  var _span = [], _input = [];
  for (var i=0;i<w.length;i++) {
    var idc = " w" + widx + "c" + i;
    var charCode = w.charCodeAt(i);
    _span.push(cwrap(w.charAt(i), "c s"));
    _input.push(cwrap(" ", "c s" + ((charCode >= 97 && charCode <= 122) ? " l" : ((charCode >= 65 && charCode <= 90) ? " u" : "")) + idc));
  }
  return {
    "span": wrap_tag("span", "w w" + widx, _span.join("")),
    "input": wrap_tag("span", "w w" + widx, _input.join(""))
  }
}
//
function innHTML(dat) {
    var marked = dat.marked;
    var dic = dat.dict;
    // @@@@@@@@@@@@@@@ 分段落
    var lines = marked.split(/\r?\n/g);
    var whtml, mwhtml, question_html = [], words = [], answer_html = [];
    for (var i=0;i<lines.length;i++){
      var line = lines[i];
      question_html.push("<p>");
      answer_html.push("<p>");
      // @@@@@@@@@@@ 分析 <w/> 标记
      var regex = /\<w\>(.*?)\<\/w\>/ig;
      var m, lastIndex = 0;
      while ((m = regex.exec(line)) !== null) {
          // This is necessary to avoid infinite loops with zero-width matches
          if (m.index === regex.lastIndex) {
              regex.lastIndex++;
          }
          var w = m[1], pre = line.substring(lastIndex, m.index);
          whtml = wwrap(pre);
          mwhtml = mwwrap(w, words.length);
          question_html.push(whtml + mwhtml.input);
          answer_html.push(whtml + mwhtml.span);
          words.push(w.split(""));
          // ============
          lastIndex = m.index + m[0].length;
      }
      whtml = wwrap(line.substring(lastIndex));
      question_html.push(whtml);
      answer_html.push(whtml);
      // @@@@@@@@@@@ 
      question_html.push("</p>\n")
      answer_html.push("</p>\n")
    }
    // console.log("\n" + question_html.join(""));
    return {
      question: question_html.join(""),
      answer: answer_html.join(""),
      words: words
    }
}
//
var ghtml = innHTML(dat);
var words = ghtml.words;
var qid = dat.qid;
//
var main_html = "<div id=\"header\" class=\"ctl\"></div>" + 
  "<div id=\"question\" class=\"block\"><div id=\"qheader\" class=\"block\"></div><div>" + ghtml.question + "</div></div>" +
  "<div id=\"answer\" class=\"block\"><div>" + ghtml.answer + "</div></div>";
document.getElementById("main").innerHTML = main_html;
// 
var MODE = 'normal';
function switchMode(m) {
  m = m === undefined ? "normal" : m;
  // 
	
  // ## 1. 根据 MODE 调整按钮及div样式
  (function(){

    var question_div = document.getElementById("question"),
      answer_div = document.getElementById("answer");
    var mm = ["normal", "exam", "finish"],
	   mpos = mm.indexOf(m);
	mm.splice(mpos, 1);
	console.log(mpos, mm, m);
	for (var i=0;i<mm.length;i++) {
	  question_div.classList.contains(mm[i]) && question_div.classList.remove(mm[i]);
	  answer_div.classList.contains(mm[i]) && answer_div.classList.remove(mm[i]);
	}
	!question_div.classList.contains(m) && question_div.classList.add(m);
	!answer_div.classList.contains(m) && answer_div.classList.add(m);
	// 
    var header_div = document.getElementById("header"),
      qheader_div = document.getElementById("qheader");
    if (m === "normal") {
      header_div.innerHTML = "<div><button id=\"btn_print\">🖨️</button><button id=\"btn_exam\">🎓</button></div>";
      qheader_div.innerHTML = "";
      qheader_div.style.visibility = "hidden";
	  //
      var btn_print = document.getElementById("btn_print"),
        btn_exam = document.getElementById("btn_exam");
      btn_print.addEventListener("click", function(e){
        window.print();
      });
      btn_exam.addEventListener("click", function(e){
        switchMode("exam");
      });
    } else if (m === "exam") {
      header_div.innerHTML = "<div><button id=\"btn_submit\">✅</button><button id=\"btn_cancel\">❎</button></div>";
      qheader_div.innerHTML = "<div class=\"status\"><span id=\"ir_count\"></span><span id=\"remaining\">⌛00:00:00</span></div>";
      qheader_div.style.visibility = "visible";
      //
      var btn_submit = document.getElementById("btn_submit"),
        btn_cancel = document.getElementById("btn_cancel");
      btn_submit.addEventListener("click", function(e){
        var msg = countInputs() ? "是否要提交？" : "看样子还没有答完，确认要提交吗？";
        if (confirm(msg)) {   // confirm
          remainingTimer && clearInterval(remainingTimer); remainingTimer = undefined;
          checkInputs();
          btn_submit.remove();
          remainingEle.innerHTML = "⌛" + fmtd(new Date(startAt), 'yyyy-MM-dd hh:mm') + " ~ " + fmtd(new Date(), 'hh:mm');
	      switchMode("finish");
          setTimeout(function(){
            window.print();
          }, 100);
        }
      });
      btn_cancel.addEventListener("click", function(e) {
        if (MODE === "finish") {
          switchMode("normal");
        } else {
          if (confirm("测试看样子还没有结束，确认要取消吗？")) {   // confirm
            remainingTimer && clearInterval(remainingTimer); remainingTimer = undefined;
            switchMode("normal");
          }
        }
      });
    } else if (m === "finish") {
      header_div.innerHTML = "<div><button id=\"btn_back\">🔙</button><button id=\"btn_reload\">🔃</button></div>";
      var btn_back = document.getElementById("btn_back"),
        btn_cancel = document.getElementById("btn_cancel");
      btn_back.addEventListener("click", function(e){
        switchMode("normal");
      });
      btn_reload.addEventListener("click", function(e) {
        switchMode("exam");
      });
	}
  })();
  //
  var remainingEle = document.getElementById("remaining"),
      remainingTimer, startAt = (new Date()).getTime();
  // ## 2. 重置可能已经输入内容
  if (m === "normal") {
    clearInputs();
  } else if (m === "exam") {
    clearInputs();
    remainingTimer = setInterval(function(){
      // console.log("remainingTimer...", remainingTimer, remainingEle);
      var diff = Math.floor(((new Date()).getTime() - startAt) / 1000); 
      var diff_str = [];
      diff_str.push(("" + Math.floor(diff / 3600)).padStart(2, "0"));  // hour
      diff = diff % 3600;
      diff_str.push(("" + Math.floor(diff / 60)).padStart(2, "0"));    // minute
      diff = diff % 60;
      diff_str.push(("" + diff).padStart(2, "0"));    // minute
      remainingEle.innerHTML = "⏱" + diff_str.join(":");
    }, 1000);
    focus2("w0c0");
  }
  //
  MODE = m;
}
//
var elements = words.map(function(word, i){
  return word.map(function(chr, j){
    var idc = "w" + i + "c" + j;
    var ele = document.getElementsByClassName(idc)[0];
    // @@@@@@@@@@@@@@@@@@@@
    ele.addEventListener("mousedown", function(e){
      if (MODE === "exam") {
        focus2(idc);
        e.preventDefault();
        e.stopPropagation();
      }
    });
    // @@@@@@@@@@@@@@@@@@@@
    return ele;
  })
});
// 
var inpEle = (function() {
  var ele = document.createElement("input")
  ele.classList.add("i");
  ele.setAttribute("maxlength", "1");
  ele.value = " ";
  //
  ele.addEventListener("input", function(e){  // 检查输入的字符是否正确
    var val = e.target.value;
    if (!valid_keydown || ele.value === "") {
      ele.value = " ";
      ele.selectionStart = 0;
      ele.selectionEnd = 0;
    }
    countInputs();
    // console.log("input....", valid_keydown);
  });
  
  var valid_keydown = false;
  ele.addEventListener("keydown", function(e){
    // console.log("keydown....", e);
    // var val = e.target.value;
    valid_keydown = true;
    if (e.keyCode === 8) {   // backspace
      ele.value = " ";
      nextC(-1);
      countInputs();
    } else if (e.keyCode === 38) {   // up
	  nextW(-1);
    } else if (e.keyCode === 40) {   // down
	  nextW(1);
    } else if (e.keyCode === 37) {   // left
      nextC(-1);
    } else if (e.keyCode === 39) {   // right
      nextC(1);
    } else if (e.keyCode === 46) {   // delete
      ele.value = " ";
      ele.selectionStart = 0;
      ele.selectionEnd = 0;
      countInputs();
    } else if (e.keyCode === 32) {   // space
      ele.value = " ";
      nextC(1);
      countInputs();
    } else if (e.keyCode === 9 || e.keyCode === 13) {    // tab, enter
      if (e.ctrlKey) {
        var btn_submit = document.getElementById("btn_submit");
        btn_submit && (btn_submit.focus() + btn_submit.click());
      } else {
        if (e.shiftKey) {
          nextC(-1);
        } else {
          nextC(1);
        }
      }
    } else if ( (!e.ctrlKey && !e.altKey && !e.metaKey ) && ((e.keyCode>=65 && e.keyCode<=90) || (e.keyCode>=97 && e.keyCode<=122))) {
      // only a-z accepted.
      ele.value = String.fromCharCode(e.keyCode);
      nextC(1);
      countInputs();
    } else if ([186].indexOf(e.keyCode) !== -1) {    // Semicolon:186(;)
      // TODO play audio
    } else if (e.keyCode === 188) {   // comma:188(,)
      input_correct('char');   // 修复这个位置字符
      countInputs();
    } else if (e.keyCode === 190) {   // period(.):190
      input_correct('word');   // 修复这个位置单词
      countInputs();
    } else if (e.keyCode === 191) {   // slash(/):191
      input_correct('part');   // 修复这个位置单词元音字符
      countInputs();
    } else {
      valid_keydown = false;
    }
    // 
    e.preventDefault();
    e.stopPropagation();
  });
  ele.addEventListener("focus", function(e){
    ele.selectionStart = 0;
    ele.selectionEnd = 0;
  });
  ele.addEventListener("blur", function(e){ 
    focus2();
  });
  return ele;
})();
//
function word_enter(widx) {
  console.log("word_enter...", words[widx]);
  playA("data:audio/mpeg;base64,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");
}
//
function word_levae(widx) {
  console.log("word_levae...", words[widx]);
}
//
function play_audio() {
  var m = /w([0-9])+c([0-9]+)/.exec(current_idc),
      w = parseInt(m[1]), c = parseInt(m[2]),
      word = words[w].join("").toLowerCase();
  // find out from dict 
}
//
var current_idc;
function focus2(target_idc) {
  if (target_idc === undefined) {
    if (current_idc !== undefined) {
      // blur
      var m0 = /w([0-9])+c([0-9]+)/.exec(current_idc),
          w0 = parseInt(m0[1]), c0 = parseInt(m0[2]),
          currentEle = elements[w0][c0],
		  currentTextEle = currentEle.firstChild;
      // console.log("set current_idc to undefined ....", current_idc, target_idc, currentTextEle);
	  currentTextEle.nodeValue = inpEle.value;
	  inpEle.remove();
      currentEle.classList.contains("f") && currentEle.classList.remove("f");
      var onchanging = inpEle.getAttribute("onchanging");
      if (onchanging === null) {
        word_levae(w0);
      } else {
        inpEle.removeAttribute("onchanging");
      }
      current_idc = undefined;
    }
    return true;
  }
  //
  if (current_idc === undefined) {     // 当前没有焦点
    var m1 = /w([0-9])+c([0-9]+)/.exec(target_idc),
        w1 = parseInt(m1[1]), c1 = parseInt(m1[2]),
        targetEle = elements[w1][c1], 
        targetTextEle = targetEle.firstChild;
    // console.log("no current_idc ....", current_idc, target_idc, targetTextEle, targetTextEle);
    inpEle.value = targetTextEle.nodeValue;
    inpEle.classList.remove("l");inpEle.classList.remove("u");
    // 
    targetEle.classList.contains("l") && inpEle.classList.add("l");
    targetEle.classList.contains("u") && inpEle.classList.add("u");
    !targetEle.classList.contains("f") && targetEle.classList.add("f");
	targetEle.appendChild(inpEle);
    //
    inpEle.focus();
    current_idc = target_idc;
    word_enter(w1);
    return true;
  }
  // 
  if (current_idc === target_idc) {
    // console.log("current_idc === target_idc ....", current_idc, target_idc);
    inpEle.selectionStart = 0;
    inpEle.selectionEnd = 0;
    // inpEle.focus();
    return false;
  }
  // 
  var m0 = /w([0-9])+c([0-9]+)/.exec(current_idc),
      w0 = parseInt(m0[1]), c0 = parseInt(m0[2]),
      currentEle = elements[w0][c0],
      currentTextEle = document.createTextNode(inpEle.value || " ");;
  var m1 = /w([0-9])+c([0-9]+)/.exec(target_idc),
      w1 = parseInt(m1[1]), c1 = parseInt(m1[2]),
      targetEle = elements[w1][c1], 
      targetTextEle = targetEle.firstChild;

  // console.log("blur and focus...", current_idc, target_idc);
  // blur
  inpEle.setAttribute("onchanging", "true")
  inpEle.blur();
  if (w0 !== w1) {
    word_levae(w0);
  }
  // console.log("blur and focus...", currentEle, targetEle);
  // focus
  inpEle.value = targetTextEle.nodeValue;
  inpEle.classList.remove("l");inpEle.classList.remove("u");
  targetEle.classList.contains("l") && inpEle.classList.add("l");
  targetEle.classList.contains("u") && inpEle.classList.add("u");
  !targetEle.classList.contains("f") && targetEle.classList.add("f");
  targetEle.appendChild(inpEle);
  // console.log("blur and focus...", currentEle, targetEle);
  inpEle.focus();
  current_idc = target_idc;
  if (w0 !== w1) {
    word_enter(w1);
  }
  return true;
}
//
function nextC(direction) { // 下一个字符
  function nextCIdc(direction) {
    direction = direction === undefined ? 0 : direction;
  
    var m = /w([0-9])+c([0-9]+)/.exec(current_idc);
    var w = parseInt(m[1]), c = parseInt(m[2]) + (direction === 0 ? 0 : (direction > 0 ? 1 : -1));
    var next;
    //
    if (direction === 0) {
      return current_idc;
    } else if (direction > 0) {
      // next of current_idc 
      for (var i=w;i>=0&&i<elements.length && next === undefined;i++) {
        var word_elements = elements[i];
        var j = (i === w ? c : 0);
        for (;j>=0&&j<word_elements.length && next === undefined;j++) {
          next = "w" + i + "c" + j;
        }
      }
      if (next === undefined) {
        next = "w0c0";
      }
      // 
      return next;
    } else if (direction < 0) {
      // prev of current_idc
      for (var i=w;i>=0&&i<elements.length && next === undefined;i--) {
        var word_elements = elements[i];
        var j = (i === w ? c : word_elements.length-1);
        for (;j>=0&&j<word_elements.length && next === undefined;j--) {
          next = "w" + i + "c" + j;
        }
      }
      if (next === undefined) {
        next = "w" + (elements.length - 1) + "c" + (elements[elements.length - 1].length - 1);
      }
      return next;
    }
  }
  //
  focus2(nextCIdc(direction));
}
function nextW(direction) { // 下一个单词
  function nextWIdc(direction) {
    direction = direction === undefined ? 0 : direction;
    var m = /w([0-9])+c([0-9]+)/.exec(current_idc);
    var w = parseInt(m[1])+ (direction === 0 ? 0 : (direction > 0 ? 1 : -1));
    var next;
    //
    if (direction === 0) {
      return current_idc;
    } else if (direction > 0) {
	  for (var i=w;i>=0&&i<elements.length && next === undefined;i++) {
          next = "w" + i + "c0";
      }
      if (next === undefined) {
        next = "w0c0";
      }
      // 
      return next;
    } else if (direction < 0) {
      for (var i=w;i>=0&&i<elements.length && next === undefined;i--) {
          next = "w" + i + "c0";
      }
      if (next === undefined) {
        next = "w" + (elements.length - 1) + "c0";
      }
      return next;
    }
  }
  focus2(nextWIdc(direction));
}
//
function input_correct(key) {
  if (current_idc !== undefined) {
    var m = /w([0-9])+c([0-9]+)/.exec(current_idc),
        w = parseInt(m[1]), 
        c = parseInt(m[2]);
    if (key === 'char') {       // 补全字符
      inpEle.value = words[w][c];
      inpEle.selectionStart = 0;
      inpEle.selectionEnd = 0;
    } else if (key === 'word') {  // 补全单词
      var word = words[w];
      for (var j=0;j<word.length;j++) {
        var node = elements[w][j].firstChild;
        if (node.nodeType !== 3) { // input
          inpEle.value = word[j];
          inpEle.selectionStart = 0;
          inpEle.selectionEnd = 0;
        } else {
          elements[w][j].replaceChild(document.createTextNode(word[j]), node);
        }
      }
    } else if (key === 'part') {  // 补全单词中的元音
      var word = words[w];
      for (var j=0;j<word.length;j++) {
        if (['a', 'e', 'i', 'o', 'u'].indexOf(word[j].toLowerCase())!==-1) {
          var node = elements[w][j].firstChild;
          if (node.nodeType !== 3) { // input
            inpEle.value = word[j];
            inpEle.selectionStart = 0;
            inpEle.selectionEnd = 0;
          } else {
            elements[w][j].replaceChild(document.createTextNode(word[j]), node);
          }
        }
      }
    }
  }
}
// 
function clearInputs() {
  focus2();
  for (var i=0;i<elements.length;i++) {
    for (var j=0;j<elements[i].length;j++) {
      var oldText = elements[i][j].firstChild,
          newText = document.createTextNode(" ");
      elements[i][j].replaceChild(newText, oldText);
      elements[i][j].classList.contains("x") && elements[i][j].classList.remove("x");
    }
  }
  countInputs();
}
//
function countInputs() {
  var ccount = 0, cinput = 0, wcount = elements.length, winput = 0, ele = document.getElementById("ir_count");
  for (var i=0;i<elements.length;i++) {
    var word_complete_input = 0;
    for (var j=0;j<elements[i].length;j++) {
      ccount = ccount + 1;
      var node = elements[i][j].firstChild;  // may input element
      var text = node.nodeType !== 3 ? node.value : node.nodeValue;
      if (text !== " ") {
        cinput = cinput + 1;
        word_complete_input = word_complete_input + 1;
      }
    }
    if (word_complete_input === elements[i].length) {
      winput = winput + 1;
    }
  }
  console.log("words count: ", winput + " / " + wcount + ", chars count: ", cinput + " / " + ccount);
  if (ele) ele.innerHTML = "📝" + (winput + "/" + wcount + "," + cinput + "/" + ccount);
  return winput === wcount;
}
//
function checkInputs() {
  var ccount = 0, cinput = 0, wcount = elements.length, winput = 0, ele = document.getElementById("ir_count");
  for (var i=0;i<elements.length;i++) {
    var word_complete_input = 0;
    for (var j=0;j<elements[i].length;j++) {
      ccount = ccount + 1;
      var node = elements[i][j].firstChild;  // may input element
      var text = node.nodeType !== 3 ? node.value : node.nodeValue;
      if (text.toLowerCase() === words[i][j].toLowerCase()) {
        cinput = cinput + 1;
        word_complete_input = word_complete_input + 1;
        elements[i][j].classList.contains("x") && elements[i][j].classList.remove("x");
      } else {
        !elements[i][j].classList.contains("x") && elements[i][j].classList.add("x");
      }
    }
    if (word_complete_input === elements[i].length) {
      winput = winput + 1;
    }
  }
  console.log("check result: words count: ", winput + " / " + wcount + ", chars count: ", cinput + " / " + ccount);
  var wrate = Math.floor(winput * 100 / wcount), crate = Math.floor(cinput * 100 / ccount);
  if (ele) ele.innerHTML = "📋"  +(winput + "/" + wcount + "=" + wrate + "%" + (wrate >= 80 ? "👍" : "👎") + "," + cinput + "/" + ccount + "=" + wrate + "%" + (crate >= 80 ? "👍" : "👎"));
}

switchMode();
-->
</script>
</div>
</body>
</html>
